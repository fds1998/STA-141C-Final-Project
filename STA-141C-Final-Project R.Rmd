---
title: "STA 141C Final Project R Markdown"
author: "Yutian Yang"
date: "3/10/2020"
output: html_document
---

```{r}
Metro_Interstate_Traffic_Volume <- read.csv("~/Metro_Interstate_Traffic_Volume.csv/Metro_Interstate_Traffic_Volume.csv")
attach(Metro_Interstate_Traffic_Volume)
library(dplyr)
library(ggpubr)
library(tidyr)
library(tidyverse)
library(ggplot2)
```

```{r}
Metro <- separate(Metro_Interstate_Traffic_Volume, date_time, c("date","time"), sep = " ", remove = TRUE, convert = FALSE, extra = "warn", fill = "warn")

Metro <- separate(Metro, date, c("year","month","date"), sep = "-", remove = TRUE, convert = FALSE, extra = "warn", fill = "warn")

ggdensity(Metro$traffic_volume, 
          main = "Density plot of tooth length",
          xlab = "Traffic Volume")

ggqqplot(Metro$traffic_volume)
```

```{r}
Metro %>%
  group_by(time)%>%
  filter(!is.na(traffic_volume)) %>%
  summarize(avg = mean(traffic_volume))%>%
  arrange(desc(avg))

Metro %>%
  group_by(month)%>%
  filter(!is.na(traffic_volume)) %>%
  summarize(avg = mean(traffic_volume))%>%
  arrange(desc(avg))

Metro %>%
  group_by(year)%>%
  filter(!is.na(traffic_volume)) %>%
  summarize(avg = mean(traffic_volume))%>%
  arrange(desc(avg))

Metro %>%
  group_by(weather_main)%>%
  filter(!is.na(traffic_volume)) %>%
  summarize(avg = mean(traffic_volume))%>%
  arrange(desc(avg))

```

```{r}
  
Metro_coef <- Metro %>%
  group_split(as.factor(month)) %>%
  map(~lm(traffic_volume~as.factor(time),data = .)) %>%
  map(function(model) model$coefficients) 


model1 = lm(Metro$traffic_volume~Metro$time)
summary(aov(model1))
confint_time = confint(model1,level=0.95)
confint_time[1,2]

model2 = lm(Metro$traffic_volume~Metro$weather_main)
summary(aov(model2))
```



```{r}
library(parallel)
cl = makeCluster(4)
B = 50

predict_newdata <- function(data){
  model = lm(data$traffic_volume~data$temp+data$clouds_all)
  coefficient = model$coefficients
  y = coefficient[[1]] + coefficient[[2]]* data$temp + coefficient[[3]]* data$clouds_all
}




singleBoots <- function(i){
  index = sample(x = seq_len(n), size = n, replace = TRUE)
  data_star = data[index,]
  predit_newdata(data_star)
}
clusterEvalQ(cl,{
  library(tidyverse)
  data <- read_csv("~/Metro_Interstate_Traffic_Volume.csv/Metro_Interstate_Traffic_Volume.csv")
  n <- length(data$traffic_volume)
  predit_newdata <- function(data){
  model = lm(data$traffic_volume~data$temp+data$clouds_all)
  coefficient = model$coefficients
  y = coefficient[[1]] + coefficient[[2]]* data$temp + coefficient[[3]]* data$clouds_all
}
})

predit_newdata = parSapply(cl, seq_len(B),singleBoots)
predit_newdata %>% quantile(c(0.025,0.975))

stopCluster(cl)
```

```{r}

```